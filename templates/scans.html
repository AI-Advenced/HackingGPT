{% extends "base.html" %}

{% block title %}Vulnerability Scans - HackingGPT{% endblock %}

{% block head %}
<style>
    .scan-card {
        transition: all 0.3s ease;
    }
    
    .scan-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-running {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
        border: 1px solid #3b82f6;
    }
    
    .status-completed {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
        border: 1px solid #22c55e;
    }
    
    .status-failed {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
        border: 1px solid #ef4444;
    }
    
    .status-pending {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
        border: 1px solid #f59e0b;
    }
    
    .scan-type-badge {
        padding: 0.125rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }
    
    .progress-bar {
        background: var(--bg-tertiary);
        border-radius: 0.5rem;
        height: 0.5rem;
        overflow: hidden;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
        height: 100%;
        transition: width 0.3s ease;
        animation: progress-shimmer 2s infinite;
    }
    
    @keyframes progress-shimmer {
        0% { background-position: -200px 0; }
        100% { background-position: calc(200px + 100%) 0; }
    }
    
    .target-input-group {
        position: relative;
    }
    
    .target-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 0.5rem 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
        display: none;
    }
    
    .target-suggestion {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s;
    }
    
    .target-suggestion:hover {
        background: var(--bg-tertiary);
    }
    
    .severity-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .severity-critical { background: #dc2626; }
    .severity-high { background: #ea580c; }
    .severity-medium { background: #d97706; }
    .severity-low { background: #65a30d; }
    .severity-info { background: #0284c7; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
        <div>
            <h1 class="text-3xl font-bold neon-glow" style="color: var(--accent-blue);">
                <i class="fas fa-search mr-3"></i>
                Vulnerability Scanner
            </h1>
            <p class="text-gray-400 mt-2">Automated security assessment and vulnerability detection</p>
        </div>
        <div class="mt-4 lg:mt-0">
            <button id="new-scan-btn" class="btn-cyber px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>
                New Scan
            </button>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="cyber-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400">Total Scans</p>
                    <p class="text-2xl font-bold">{{ scans|length }}</p>
                </div>
                <div class="p-3 bg-blue-900 rounded-full">
                    <i class="fas fa-search text-blue-400"></i>
                </div>
            </div>
        </div>
        
        <div class="cyber-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400">Running</p>
                    <p class="text-2xl font-bold text-blue-400">
                        {{ scans|selectattr('status', 'equalto', 'running')|list|length }}
                    </p>
                </div>
                <div class="p-3 bg-blue-900 rounded-full">
                    <i class="fas fa-spinner text-blue-400"></i>
                </div>
            </div>
        </div>
        
        <div class="cyber-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400">Completed</p>
                    <p class="text-2xl font-bold text-green-400">
                        {{ scans|selectattr('status', 'equalto', 'completed')|list|length }}
                    </p>
                </div>
                <div class="p-3 bg-green-900 rounded-full">
                    <i class="fas fa-check text-green-400"></i>
                </div>
            </div>
        </div>
        
        <div class="cyber-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400">Failed</p>
                    <p class="text-2xl font-bold text-red-400">
                        {{ scans|selectattr('status', 'equalto', 'failed')|list|length }}
                    </p>
                </div>
                <div class="p-3 bg-red-900 rounded-full">
                    <i class="fas fa-times text-red-400"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scan Types Reference -->
    <div class="cyber-card p-6">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-list mr-2" style="color: var(--accent-green);"></i>
            Available Scan Types
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for scan_id, scan_desc in scan_types.items() %}
            <div class="border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition-colors">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold">{{ scan_id.replace('_', ' ').title() }}</h3>
                    <i class="fas fa-
                        {%- if 'nmap' in scan_id -%}network-wired
                        {%- elif 'nikto' in scan_id -%}globe
                        {%- elif 'sqlmap' in scan_id -%}database
                        {%- elif 'dirb' in scan_id -%}folder-open
                        {%- else -%}search
                        {%- endif -%} text-gray-400"></i>
                </div>
                <p class="text-sm text-gray-400">{{ scan_desc }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Active Scans -->
    {% set running_scans = scans|selectattr('status', 'equalto', 'running')|list %}
    {% if running_scans %}
    <div class="cyber-card p-6">
        <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-spinner fa-spin mr-2" style="color: var(--accent-blue);"></i>
            Active Scans
        </h2>
        
        <div class="space-y-4">
            {% for scan in running_scans %}
            <div class="border border-blue-500 rounded-lg p-4 bg-blue-900/20">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <span class="status-badge status-running">Running</span>
                        <span class="scan-type-badge">{{ scan.scan_type }}</span>
                        <span class="text-sm text-gray-300">{{ scan.target }}</span>
                    </div>
                    <button onclick="viewScanDetails({{ scan.id }})" 
                            class="text-blue-400 hover:text-blue-300">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <div class="progress-bar mb-2">
                    <div class="progress-fill" style="width: 65%"></div>
                </div>
                
                <div class="flex items-center justify-between text-xs text-gray-400">
                    <span>Started: {{ scan.created_at }}</span>
                    <span>Estimated: ~5 min remaining</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Scan History -->
    <div class="cyber-card p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">
                <i class="fas fa-history mr-2" style="color: var(--accent-pink);"></i>
                Scan History
            </h2>
            <div class="flex items-center space-x-2">
                <select id="filter-status" class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                    <option value="running">Running</option>
                </select>
                <select id="filter-type" class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm">
                    <option value="">All Types</option>
                    {% for scan_id in scan_types.keys() %}
                    <option value="{{ scan_id }}">{{ scan_id.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        {% if scans %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-600">
                        <th class="text-left py-3 px-4 font-semibold">Target</th>
                        <th class="text-left py-3 px-4 font-semibold">Type</th>
                        <th class="text-left py-3 px-4 font-semibold">Status</th>
                        <th class="text-left py-3 px-4 font-semibold">Started</th>
                        <th class="text-left py-3 px-4 font-semibold">Duration</th>
                        <th class="text-left py-3 px-4 font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scans %}
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors scan-row"
                        data-status="{{ scan.status }}" data-type="{{ scan.scan_type }}">
                        <td class="py-4 px-4">
                            <div class="flex items-center">
                                <i class="fas fa-
                                    {%- if scan.target.startswith('http') -%}globe
                                    {%- else -%}server
                                    {%- endif -%} mr-2 text-gray-400"></i>
                                <span class="font-medium">{{ scan.target }}</span>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <span class="scan-type-badge">{{ scan.scan_type }}</span>
                        </td>
                        <td class="py-4 px-4">
                            <span class="status-badge status-{{ scan.status }}">{{ scan.status }}</span>
                        </td>
                        <td class="py-4 px-4 text-sm text-gray-400">
                            {{ scan.created_at }}
                        </td>
                        <td class="py-4 px-4 text-sm text-gray-400">
                            {% if scan.completed_at %}
                                {% set duration = (scan.completed_at | string)[:19] %}
                                {{ duration }}
                            {% else %}
                                {% if scan.status == 'running' %}
                                <i class="fas fa-spinner fa-spin mr-1"></i>Running
                                {% else %}
                                -
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="py-4 px-4">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewScanDetails({{ scan.id }})" 
                                        class="text-blue-400 hover:text-blue-300 p-1" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if scan.status == 'completed' %}
                                <button onclick="downloadReport({{ scan.id }})" 
                                        class="text-green-400 hover:text-green-300 p-1" 
                                        title="Download Report">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="rescanTarget('{{ scan.target }}', '{{ scan.scan_type }}')" 
                                        class="text-yellow-400 hover:text-yellow-300 p-1" 
                                        title="Rescan">
                                    <i class="fas fa-redo"></i>
                                </button>
                                {% endif %}
                                <button onclick="deleteScan({{ scan.id }})" 
                                        class="text-red-400 hover:text-red-300 p-1" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-search text-6xl text-gray-600 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">No Scans Yet</h3>
            <p class="text-gray-400 mb-6">Start your first vulnerability scan to begin security assessment</p>
            <button onclick="document.getElementById('new-scan-btn').click()" 
                    class="btn-cyber px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>
                Start First Scan
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- New Scan Modal -->
<div id="new-scan-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="cyber-card p-8 max-w-2xl w-full terminal-border">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold neon-glow" style="color: var(--accent-blue);">
                    <i class="fas fa-search mr-3"></i>
                    New Vulnerability Scan
                </h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="new-scan-form" class="space-y-6">
                <!-- Target Input -->
                <div class="target-input-group">
                    <label for="scan-target" class="block text-sm font-medium mb-2">
                        <i class="fas fa-bullseye mr-2" style="color: var(--accent-green);"></i>
                        Target
                    </label>
                    <input type="text" 
                           id="scan-target" 
                           name="target" 
                           required
                           placeholder="e.g., example.com, 192.168.1.1, https://target.com"
                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    
                    <!-- Target Suggestions -->
                    <div id="target-suggestions" class="target-suggestions">
                        <div class="target-suggestion" onclick="selectTarget('scanme.nmap.org')">
                            <i class="fas fa-server mr-2"></i>
                            scanme.nmap.org <span class="text-xs text-gray-400">(Test Server)</span>
                        </div>
                        <div class="target-suggestion" onclick="selectTarget('testphp.vulnweb.com')">
                            <i class="fas fa-globe mr-2"></i>
                            testphp.vulnweb.com <span class="text-xs text-gray-400">(Test Web App)</span>
                        </div>
                        <div class="target-suggestion" onclick="selectTarget('demo.testfire.net')">
                            <i class="fas fa-shield-alt mr-2"></i>
                            demo.testfire.net <span class="text-xs text-gray-400">(Banking Demo)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Scan Type -->
                <div>
                    <label for="scan-type" class="block text-sm font-medium mb-2">
                        <i class="fas fa-cogs mr-2" style="color: var(--accent-pink);"></i>
                        Scan Type
                    </label>
                    <select id="scan-type" 
                            name="scan_type" 
                            required
                            class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select scan type...</option>
                        {% for scan_id, scan_desc in scan_types.items() %}
                        <option value="{{ scan_id }}">{{ scan_desc }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Scan Description -->
                <div id="scan-description" class="hidden p-4 bg-gray-800 border border-gray-600 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-400 mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-semibold mb-1">Scan Details</h4>
                            <p id="scan-desc-text" class="text-sm text-gray-400"></p>
                            <div class="mt-2">
                                <span class="text-xs text-gray-500">Estimated Duration: </span>
                                <span id="scan-duration" class="text-xs text-blue-400"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Options -->
                <div>
                    <button type="button" 
                            id="toggle-advanced" 
                            class="flex items-center text-sm text-blue-400 hover:text-blue-300">
                        <i class="fas fa-chevron-right mr-2 transition-transform" id="advanced-chevron"></i>
                        Advanced Options
                    </button>
                    
                    <div id="advanced-options" class="hidden mt-4 space-y-4 p-4 bg-gray-800 border border-gray-600 rounded-lg">
                        <div>
                            <label for="scan-timeout" class="block text-sm font-medium mb-2">Timeout (seconds)</label>
                            <input type="number" 
                                   id="scan-timeout" 
                                   name="timeout" 
                                   value="300" 
                                   min="30" 
                                   max="3600"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                        </div>
                        
                        <div>
                            <label for="scan-threads" class="block text-sm font-medium mb-2">Threads</label>
                            <input type="number" 
                                   id="scan-threads" 
                                   name="threads" 
                                   value="10" 
                                   min="1" 
                                   max="50"
                                   class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
                        </div>
                        
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="scan-aggressive" name="aggressive" class="mr-2">
                                <span class="text-sm">Aggressive Mode (Higher Detection, More Intrusive)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Warning -->
                <div class="p-4 bg-yellow-900 border border-yellow-600 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i>
                        <div class="text-yellow-200 text-sm">
                            <strong>Security Notice:</strong> Only scan targets you own or have explicit permission to test. 
                            Unauthorized scanning may be illegal and could result in serious consequences.
                        </div>
                    </div>
                </div>
                
                <!-- Submit Buttons -->
                <div class="flex justify-end space-x-4">
                    <button type="button" 
                            id="cancel-scan-btn" 
                            class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" 
                            id="start-scan-btn" 
                            class="btn-cyber px-6 py-3 rounded-lg">
                        <i class="fas fa-play mr-2"></i>
                        Start Scan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scan Details Modal -->
<div id="scan-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="cyber-card p-8 max-w-4xl w-full terminal-border max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-chart-bar mr-3" style="color: var(--accent-green);"></i>
                    Scan Results
                </h2>
                <button id="close-details-btn" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="scan-details-content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Modal elements
    const newScanModal = document.getElementById('new-scan-modal');
    const scanDetailsModal = document.getElementById('scan-details-modal');
    const newScanBtn = document.getElementById('new-scan-btn');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const closeDetailsBtn = document.getElementById('close-details-btn');
    const cancelScanBtn = document.getElementById('cancel-scan-btn');
    
    // Form elements
    const newScanForm = document.getElementById('new-scan-form');
    const scanTargetInput = document.getElementById('scan-target');
    const scanTypeSelect = document.getElementById('scan-type');
    const scanDescription = document.getElementById('scan-description');
    const scanDescText = document.getElementById('scan-desc-text');
    const scanDuration = document.getElementById('scan-duration');
    const targetSuggestions = document.getElementById('target-suggestions');
    
    // Filter elements
    const filterStatus = document.getElementById('filter-status');
    const filterType = document.getElementById('filter-type');
    
    // Scan type descriptions and durations
    const scanInfo = {
        'nmap_basic': {
            description: 'Basic port scan to identify open services and basic information.',
            duration: '1-2 minutes'
        },
        'nmap_service': {
            description: 'Service version detection with script scanning for detailed enumeration.',
            duration: '3-5 minutes'
        },
        'nmap_vuln': {
            description: 'Vulnerability detection using Nmap NSE scripts.',
            duration: '5-10 minutes'
        },
        'nikto': {
            description: 'Web server vulnerability scanner for common web application issues.',
            duration: '2-5 minutes'
        },
        'dirb': {
            description: 'Directory and file brute-force discovery for web applications.',
            duration: '5-15 minutes'
        },
        'sqlmap': {
            description: 'Automated SQL injection detection and exploitation.',
            duration: '10-30 minutes'
        }
    };
    
    // Event listeners
    newScanBtn.addEventListener('click', () => openModal(newScanModal));
    closeModalBtn.addEventListener('click', () => closeModal(newScanModal));
    closeDetailsBtn.addEventListener('click', () => closeModal(scanDetailsModal));
    cancelScanBtn.addEventListener('click', () => closeModal(newScanModal));
    
    // Scan type change
    scanTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        if (selectedType && scanInfo[selectedType]) {
            const info = scanInfo[selectedType];
            scanDescText.textContent = info.description;
            scanDuration.textContent = info.duration;
            scanDescription.classList.remove('hidden');
        } else {
            scanDescription.classList.add('hidden');
        }
    });
    
    // Target input focus/blur for suggestions
    scanTargetInput.addEventListener('focus', function() {
        if (!this.value.trim()) {
            targetSuggestions.style.display = 'block';
        }
    });
    
    scanTargetInput.addEventListener('blur', function() {
        // Delay to allow clicks on suggestions
        setTimeout(() => {
            targetSuggestions.style.display = 'none';
        }, 200);
    });
    
    scanTargetInput.addEventListener('input', function() {
        if (this.value.trim()) {
            targetSuggestions.style.display = 'none';
        } else {
            targetSuggestions.style.display = 'block';
        }
    });
    
    // Advanced options toggle
    document.getElementById('toggle-advanced').addEventListener('click', function() {
        const advancedOptions = document.getElementById('advanced-options');
        const chevron = document.getElementById('advanced-chevron');
        
        if (advancedOptions.classList.contains('hidden')) {
            advancedOptions.classList.remove('hidden');
            chevron.style.transform = 'rotate(90deg)';
        } else {
            advancedOptions.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    });
    
    // Form submission
    newScanForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const scanData = {
            target: formData.get('target').trim(),
            scan_type: formData.get('scan_type'),
            options: {
                timeout: parseInt(formData.get('timeout')) || 300,
                threads: parseInt(formData.get('threads')) || 10,
                aggressive: formData.get('aggressive') === 'on'
            }
        };
        
        // Validate target
        if (!isValidTarget(scanData.target)) {
            showNotification('Please enter a valid target (domain, IP, or URL)', 'error');
            return;
        }
        
        try {
            const startScanBtn = document.getElementById('start-scan-btn');
            startScanBtn.disabled = true;
            startScanBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting...';
            
            const response = await fetch('/api/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scanData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Scan started successfully', 'success');
                closeModal(newScanModal);
                
                // Refresh page to show new scan
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } else {
                showNotification('Failed to start scan: ' + result.error, 'error');
            }
            
        } catch (error) {
            showNotification('Error starting scan: ' + error.message, 'error');
        } finally {
            const startScanBtn = document.getElementById('start-scan-btn');
            startScanBtn.disabled = false;
            startScanBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Scan';
        }
    });
    
    // Filters
    filterStatus.addEventListener('change', filterScans);
    filterType.addEventListener('change', filterScans);
    
    // Auto-refresh running scans every 30 seconds
    setInterval(refreshRunningScan, 30000);
    
    // Close modals on outside click
    window.addEventListener('click', function(e) {
        if (e.target === newScanModal) closeModal(newScanModal);
        if (e.target === scanDetailsModal) closeModal(scanDetailsModal);
    });
});

// Helper functions
function openModal(modal) {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal(modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function selectTarget(target) {
    document.getElementById('scan-target').value = target;
    document.getElementById('target-suggestions').style.display = 'none';
}

function isValidTarget(target) {
    // Basic validation for domains, IPs, and URLs
    const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/;
    const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    const urlRegex = /^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/;
    
    return domainRegex.test(target) || ipRegex.test(target) || urlRegex.test(target);
}

function filterScans() {
    const statusFilter = document.getElementById('filter-status').value;
    const typeFilter = document.getElementById('filter-type').value;
    const rows = document.querySelectorAll('.scan-row');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const type = row.getAttribute('data-type');
        
        const statusMatch = !statusFilter || status === statusFilter;
        const typeMatch = !typeFilter || type === typeFilter;
        
        if (statusMatch && typeMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

async function viewScanDetails(scanId) {
    try {
        const response = await fetch(`/api/scan/${scanId}`);
        const scanData = await response.json();
        
        if (scanData.error) {
            showNotification('Error loading scan details: ' + scanData.error, 'error');
            return;
        }
        
        // Populate scan details modal
        const content = document.getElementById('scan-details-content');
        content.innerHTML = generateScanDetailsHTML(scanData);
        
        openModal(document.getElementById('scan-details-modal'));
        
    } catch (error) {
        showNotification('Failed to load scan details', 'error');
    }
}

function generateScanDetailsHTML(scan) {
    let html = `
        <div class="space-y-6">
            <!-- Scan Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="cyber-card p-4">
                    <h3 class="font-semibold mb-3">Scan Information</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Target:</span>
                            <span>${scan.target}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Type:</span>
                            <span class="scan-type-badge">${scan.scan_type}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Status:</span>
                            <span class="status-badge status-${scan.status}">${scan.status}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Started:</span>
                            <span>${scan.created_at}</span>
                        </div>
                        ${scan.completed_at ? `
                        <div class="flex justify-between">
                            <span class="text-gray-400">Completed:</span>
                            <span>${scan.completed_at}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
    `;
    
    // Add severity counts if available
    if (scan.severity_counts) {
        html += `
                <div class="cyber-card p-4">
                    <h3 class="font-semibold mb-3">Vulnerability Summary</h3>
                    <div class="space-y-2">
                        ${Object.entries(scan.severity_counts).map(([severity, count]) => `
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="severity-indicator severity-${severity}"></span>
                                <span class="capitalize">${severity}</span>
                            </div>
                            <span class="font-bold">${count}</span>
                        </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    } else {
        html += `</div>`;
    }
    
    // Add results if available
    if (scan.results) {
        html += `
            <div class="cyber-card p-4">
                <h3 class="font-semibold mb-3">Scan Output</h3>
                <div class="bg-black rounded p-4 font-mono text-sm overflow-x-auto">
                    <pre class="text-green-400">${escapeHtml(scan.results.output || 'No output available')}</pre>
                </div>
            </div>
        `;
        
        if (scan.results.command) {
            html += `
                <div class="cyber-card p-4">
                    <h3 class="font-semibold mb-3">Command Executed</h3>
                    <div class="bg-gray-800 rounded p-3 font-mono text-sm">
                        <code>${escapeHtml(scan.results.command)}</code>
                    </div>
                </div>
            `;
        }
    }
    
    html += `</div>`;
    return html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function downloadReport(scanId) {
    try {
        const response = await fetch(`/api/scan/${scanId}/report`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan_report_${scanId}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            showNotification('Failed to download report', 'error');
        }
    } catch (error) {
        showNotification('Error downloading report', 'error');
    }
}

function rescanTarget(target, scanType) {
    document.getElementById('scan-target').value = target;
    document.getElementById('scan-type').value = scanType;
    document.getElementById('scan-type').dispatchEvent(new Event('change'));
    openModal(document.getElementById('new-scan-modal'));
}

async function deleteScan(scanId) {
    if (!confirm('Are you sure you want to delete this scan?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/scan/${scanId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('Scan deleted successfully', 'success');
            location.reload();
        } else {
            showNotification('Failed to delete scan', 'error');
        }
    } catch (error) {
        showNotification('Error deleting scan', 'error');
    }
}

function refreshRunningScan() {
    const runningScans = document.querySelectorAll('.scan-row[data-status="running"]');
    
    runningScans.forEach(async (row) => {
        const scanId = row.getAttribute('data-scan-id');
        if (scanId) {
            try {
                const response = await fetch(`/api/scan/${scanId}`);
                const scanData = await response.json();
                
                if (scanData.status !== 'running') {
                    location.reload();
                }
            } catch (error) {
                console.log('Error refreshing scan status:', error);
            }
        }
    });
}
</script>
{% endblock %}